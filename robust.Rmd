---
title: "Robust"
output: pdf_document
date: "2025-11-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(tidyverse)
library(quantreg)
library(car)
```

Read data and subset to columns used for RLM

```{r}
df <-  read.csv("merged_data.csv")
data <- df[, c("arr_delay", "distance", "dep_hr", "awnd", "prcp", "snow", "tmax", "tmin")]
data <- drop_na(data)
```

Define unsupplied psis

```{r}
# least squares loss
psi.ls <- function(u, deriv = 0) {
  n = length(u)
  return(rep(1, n))
}

# Andrews' Sine (not working currently)
psi.andrew <- function(u, c = 1.339, deriv = 0) {
  t = u/c
  if (!deriv) {
    return(ifelse(abs(u)<pi*c, sin(t)/t, 0))
  }
  return(ifelse(abs(u)<pi*c, (u*cos(t)-c*sin(t))/u^2, 0))
}
```


Choose which M-estimators to use

```{r}
M.estimators <- c(
  least.square = psi.ls,
  least.abs.dev = NA,
  huber = psi.huber,
  hampel = psi.hampel,
  tukey = psi.bisquare
  # andrews = psi.andrew
)
```

Perform robust regression with outliers present

```{r}
for (M.estimator in names(M.estimators)) {
  M.phi <- M.estimators[[M.estimator]]
  
  if (M.estimator == "least.abs.dev") {
    # least absolute deviation requires a different function to fit the model
    model <- rq(arr_delay ~ ., data = data)
  } else {
    model <- rlm(arr_delay ~ ., data = data, psi = M.phi)
  }
  
  metric <- mad(model$residuals) # mean absolute deviation
  
  params <- summary(model)$coef
  
  print(paste(M.estimator, metric, sep = ": "))
  print(params)
}
```
Identify outliers based on least-squares model

```{r}
model.lm = lm(arr_delay ~ ., data = data)
outlier.test.results <- outlierTest(model.lm, cutoff = 0.05, n.max = 200)
outlier.indices <- as.integer(names(outlier.test.results$rstudent))
data.no.outliers <- data[-outlier.indices,]
```

Perform robust regression without outliers present

```{r}
for (M.estimator in names(M.estimators)) {
  M.phi <- M.estimators[[M.estimator]]
  
  if (M.estimator == "least.abs.dev") {
    # least absolute deviation requires a different function to fit the model
    model <- rq(arr_delay ~ ., data = data.no.outliers)
  } else {
    model <- rlm(arr_delay ~ ., data = data.no.outliers, psi = M.phi)
  }
  
  metric <- mad(model$residuals) # mean absolute deviation
  
  params <- summary(model)$coef
  
  print(paste(M.estimator, metric, sep = ": "))
  print(params)
}
```

