---
title: "Robust"
output: pdf_document
date: "2025-11-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(tidyverse)
library(quantreg)
library(car)
library(this.path)
setwd(this.path::here())
```

Read data and subset to columns used for RLM

```{r}
df <-  read.csv("full_data_ohare_2024_v2.csv")
data <- df[, c("arr_delay", "prcp", "snow", "tmax", "distance", "dow_mod", "crs_dep_time_base10")]
data <- drop_na(data)
```

Define unsupplied psis

```{r}
# least squares loss
psi.ls <- function(u, deriv = 0) {
  n = length(u)
  return(rep(1, n))
}

# Andrews' Sine
psi.andrew <- function(u, c = 1.339, deriv = 0) {
  t = u/c
  if (!deriv) {
    return(ifelse(abs(u)<=pi*c, sin(t)/u, 0))
  }
  return(ifelse(abs(u)<=pi*c, cos(t)/c, 0))
}
```


Choose which M-estimators to use

```{r}
M.estimators <- c(
  least.square = psi.ls,
  least.abs.dev = NA,
  huber = psi.huber,
  tukey = psi.bisquare,
  andrews = psi.andrew
)
```

Perform robust regression with outliers present

```{r}
MADs <- numeric()
for (M.estimator in names(M.estimators)) {
  M.phi <- M.estimators[[M.estimator]]
  
  if (M.estimator == "least.abs.dev") {
    # least absolute deviation requires a different function to fit the model
    model <- rq(arr_delay ~ ., data = data)
  } else {
    model <- rlm(arr_delay ~ ., data = data, psi = M.phi)
  }
  
  MAD <- mad(model$residuals) # mean absolute deviation
  MADs[M.estimator] = MAD
  
  params <- summary(model)$coef
  M.estimator.underscores = str_replace_all(M.estimator, "\\.", "_")
  write.csv(params, paste("coefficients/params_", M.estimator.underscores, "_1.csv", sep = ""))
  
  print(paste(M.estimator, MAD, sep = ": "))
  print(params)
}
```
Identify outliers based on least-squares model

```{r}
model.lm = lm(arr_delay ~ ., data = data)
outlier.test.results <- outlierTest(model.lm, cutoff = 0.05, n.max = 2000)
outlier.indices <- as.integer(names(outlier.test.results$rstudent))
print(length(outlier.indices))
data.no.outliers <- data[-outlier.indices,]
```

Perform robust regression without outliers present

```{r}
MADs = numeric()
for (M.estimator in names(M.estimators)) {
  M.phi <- M.estimators[[M.estimator]]
  
  if (M.estimator == "least.abs.dev") {
    # least absolute deviation requires a different function to fit the model
    model <- rq(arr_delay ~ ., data = data.no.outliers)
  } else {
    model <- rlm(arr_delay ~ ., data = data.no.outliers, psi = M.phi)
  }
  
  MAD <- mad(model$residuals) # mean absolute deviation
  MADs[M.estimator] = MAD
  
  M.estimator.underscores = str_replace_all(M.estimator, "\\.", "_")
  write.csv(params, paste("coefficients/params_", M.estimator.underscores, "_2.csv", sep = ""))
  
  print(paste(M.estimator, MAD, sep = ": "))
  print(params)
}
```

